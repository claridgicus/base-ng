name: Investigate Component Issue

on:
  issues:
    types: [labeled]

jobs:
  investigate:
    if: github.event.label.name == 'investigate'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Extract component from issue
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title.toLowerCase();
            const body = issue.body?.toLowerCase() || '';

            // List of known components
            const components = [
              'accordion', 'alert-dialog', 'autocomplete', 'avatar', 'button',
              'checkbox', 'checkbox-group', 'collapsible', 'combobox', 'context-menu',
              'dialog', 'field', 'fieldset', 'form', 'input', 'menu', 'menubar',
              'meter', 'navigation-menu', 'number-field', 'popover', 'preview-card',
              'progress', 'radio', 'radio-group', 'scroll-area', 'select', 'separator',
              'slider', 'switch', 'tabs', 'toast', 'toggle', 'toggle-group', 'toolbar', 'tooltip'
            ];

            // Find mentioned component
            let component = null;
            for (const c of components) {
              if (title.includes(c) || body.includes(c)) {
                component = c;
                break;
              }
            }

            if (component) {
              core.setOutput('component', component);
              core.setOutput('found', 'true');
            } else {
              core.setOutput('found', 'false');
            }

            return component;

      - name: Run Claude Code investigation
        if: steps.extract.outputs.found == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          npx @anthropic-ai/claude-code --print "
            Investigate GitHub issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}

            Issue body:
            ${{ github.event.issue.body }}

            Focus on the ${{ steps.extract.outputs.component }} component.

            1. Run the tests for this component
            2. Check if there are any obvious bugs or issues
            3. Provide a summary of findings
          " > investigation.md

      - name: Comment on issue
        if: steps.extract.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const investigation = fs.readFileSync('investigation.md', 'utf8');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ü§ñ Automated Investigation\n\n${investigation}\n\n---\n*This investigation was automatically triggered by the \`investigate\` label.*`
            });

      - name: Comment if no component found
        if: steps.extract.outputs.found == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚ö†Ô∏è Could not identify which component this issue relates to. Please mention the component name in the issue title or description.`
            });
